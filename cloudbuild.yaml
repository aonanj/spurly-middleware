steps:
  # Check for Artifact Registry repository and create if it doesn't exist
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gcloud artifacts repositories describe spurly-middleware --location=us-west2 --project=$PROJECT_ID &> /dev/null
        if [ $$? -ne 0 ]; then
          echo "Repository 'spurly-middleware' does not exist. Creating..."
          gcloud artifacts repositories create spurly-middleware \
            --repository-format=docker \
            --location=us-west2 \
            --description="Spurly Middleware repository" \
            --project=$$PROJECT_ID
        else
          echo "Repository 'spurly-middleware' already exists."
        fi
    id: 'create-repo'

  # Build the container image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build'
    waitFor:
      - 'create-repo'
    args: [
      'build',
      '-t', 'us-west2-docker.pkg.dev/$PROJECT_ID/spurly-middleware/spurly-middleware:$COMMIT_SHA',
      '-t', 'us-west2-docker.pkg.dev/$PROJECT_ID/spurly-middleware/spurly-middleware:latest',
      '.'
    ]

  # Push the container image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push'
    args: [
      'push', '--all-tags', 'us-west2-docker.pkg.dev/$PROJECT_ID/spurly-middleware/spurly-middleware'
    ]

  # Deploy to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args: [
      'run', 'deploy', 'spurly-middleware',
      '--image', 'us-west2-docker.pkg.dev/$PROJECT_ID/spurly-middleware/spurly-middleware:$COMMIT_SHA',
      '--region', 'us-west2',
      '--platform', 'managed',
      '--service-account', 'firebase-adminsdk-fbsvc@boreal-sweep-455716-a5.iam.gserviceaccount.com',
      '--port', '8080',
      '--memory', '2Gi',
      '--cpu', '2',
      '--min-instances', '0',
      '--max-instances', '20',
      '--timeout', '900',
      '--concurrency', '100',
      '--update-env-vars', '^#^GOOGLE_PROJECT_ID=boreal-sweep-455716-a5#GCS_PROFILE_PICS_BUCKET=boreal-sweep-455716-a5.firebase.storage.app#APPLE_BUNDLE_ID=com.phaeton-order.spurly#APPLE_CLIENT_ID=com.phaeton-order.spurly#ALGOLIA_APP_ID=80RD9TN1W0#ALGOLIA_INDEX_NAME=conversations#FACEBOOK_APP_ID=658231117325254#SUPPORT_FROM_EMAIL=noreply@mg.spurly.io#SUPPORT_TO_EMAIL=support@spurly.io#MAILGUN_API_BASE=https://api.mailgun.net/v3#MAILGUN_DOMAIN=mg.spurly.io#GOOGLE_CLOUD_FIREBASE_CREDS=/secrets/firebase/boreal-sweep-455716-a5-8bd41e062f23#GOOGLE_CLOUD_FIRESTORE_CREDS=/secrets/firestore/boreal-sweep-455716-a5-a26b96a8291e#GOOGLE_CLOUD_VISION_CREDS=/secrets/vision/boreal-sweep-455716-a5-dcf73e821d5f#GOOGLE_CLOUD_VERTEX_CREDS=/secrets/vertex/boreal-sweep-455716-a5-4115fa345e3f',
      '--set-secrets', '/secrets/firebase/boreal-sweep-455716-a5-8bd41e062f23=boreal-sweep-455716-a5-8bd41e062f23:latest,/secrets/firestore/boreal-sweep-455716-a5-a26b96a8291e=boreal-sweep-455716-a5-a26b96a8291e:latest,/secrets/vision/boreal-sweep-455716-a5-dcf73e821d5f=boreal-sweep-455716-a5-dcf73e821d5f:latest,/secrets/vertex/boreal-sweep-455716-a5-4115fa345e3f=boreal-sweep-455716-a5-4115fa345e3f:latest,ALGOLIA_SEARCH_API_KEY=algolia-search-api-key:latest,ALGOLIA_WRITE_API_KEY=algolia-write-api-key:latest,FACEBOOK_APP_SECRET=facebook-app-secret:latest,APP_OATH_KEY=app-oath-key:latest,FACEBOOK_CLIENT_TOKEN=facebook-client-token:latest,GOOGLE_CLIENT_ID=google-client-id:latest,GOOGLE_REVERSED_CLIENT_ID=google-reversed-client-id:latest,JWT_SECRET_KEY=jwt-secret-key:latest,OPENAI_API_KEY=openai-api-key:latest,NEWS_API_KEY=NEWS_API_KEY:latest,REDDIT_CLIENT_SECRET=reddit-client-secret:latest,REDDIT_CLIENT_ID=reddit-client-id:latest,GOOGLE_WEB_CLIENT_ID=google-web-client-id:latest,SENDGRID_API_KEY=sendgrid-api-key:latest,MAILGUN_API_KEY=mailgun-api-key:latest,MAILERLITE_WEBHOOK_SECRET=mailerlite-webhook-secret:latest'
    ]
    id: 'deploy-cloud-run'
    waitFor:
      - 'push'

# Service account configuration
serviceAccount: 'projects/boreal-sweep-455716-a5/serviceAccounts/firebase-adminsdk-fbsvc@boreal-sweep-455716-a5.iam.gserviceaccount.com'

# Build options
options:
  logging: 'CLOUD_LOGGING_ONLY'
  substitutionOption: 'ALLOW_LOOSE'
  diskSizeGb: '100'

# Timeout for the entire build
timeout: '1800s'

# Optional substitutions (safe to leave)
substitutions:
  _SERVICE_NAME: 'spurly-middleware'
  _REGION: 'us-west2'
